unit TestFireDACAdapter;

interface

uses
  TestFramework, Spring.Persistence.Adapters.FireDAC, Spring.Persistence.Core.Base, SysUtils,
  Spring.Persistence.SQL.Params, Spring.Persistence.Core.Interfaces
  , Spring.Persistence.SQL.Generators.Ansi, Spring.Persistence.Core.Session
  ,TestEntities, Classes, FireDAC.Comp.Client, Spring.Persistence.Mapping.Attributes;

type
  [Table('CUSTOMERS')]
  TFDCustomer = class
  private
    FId: Integer;
    FAge: Integer;
    FName: string;
    FHeight: Double;
  public
    [Column('ID', [cpPrimaryKey])] [AutoGenerated] property Id: Integer read FId write FId;
    [Column] property Age: Integer read FAge write FAge;
    [Column] property Name: string read FName write FName;
    [Column] property Height: Double read FHeight write FHeight;
  end;

  TestFireDACSession = class(TTestCase)
  private
    FConnection: IDBConnection;
    FSession: TSession;
    FDACConnection: TFDConnection;
  protected
    procedure CreateTables;
    function CreateCustomer(const name: string; const age: Integer): TFDCustomer;
  public
    procedure SetUp; override;
    procedure TearDown; override;
  published
    procedure Save;
    procedure WhenSavingInTransaction_RollbackIsSuccessful;
    procedure WhenSavingInTransaction_CommitIsSuccessful;


  end;

implementation

uses
  Spring.Persistence.Core.ConnectionFactory
  ,FireDAC.Phys.SQLite
  ,Spring.Persistence.SQL.Interfaces
  ;

{ TestFireDACSession }

function TestFireDACSession.CreateCustomer(const name: string;
  const age: Integer): TFDCustomer;
begin
  Result := TFDCustomer.Create;
  Result.Name := name;
  Result.Age := age;
end;

procedure TestFireDACSession.CreateTables;
begin
  FDACConnection.ExecSQL('CREATE TABLE IF NOT EXISTS CUSTOMERS ([ID] INTEGER PRIMARY KEY, [AGE] INTEGER NULL,'+
    '[NAME] VARCHAR (255), [HEIGHT] FLOAT, [PICTURE] BLOB); ');
end;

procedure TestFireDACSession.Save;
var
  customer: TFDCustomer;
begin
  customer := CreateCustomer('Foo', 25);

  FSession.Save(customer);

  CheckEquals('Foo', FSession.FindAll<TFDCustomer>.First.Name);
  customer.Free;
end;

procedure TestFireDACSession.SetUp;
begin
  FDACConnection := TFDConnection.Create(nil);
  FDACConnection.DriverName := 'SQLite';
 // FDACConnection.Params.Add('Database=file::memory:?cache=shared');
 // FDACConnection.Params.Add('Database=:memory:');
//  inherited SetUp;
  FConnection := TConnectionFactory.GetInstance(dtFireDAC, FDACConnection);
  FConnection.SetQueryLanguage(qlSQLite);
  FSession := TSession.Create(FConnection);
  CreateTables;
end;

procedure TestFireDACSession.TearDown;
begin
  inherited TearDown;
  FDACConnection.Free;
  FSession.Free;
end;

procedure TestFireDACSession.WhenSavingInTransaction_CommitIsSuccessful;
var
  customer: TFDCustomer;
  transaction: IDBTransaction;
begin
  customer := CreateCustomer('Foo', 25);

  transaction := FSession.BeginTransaction;
  FSession.Save(customer);
  customer.Free;

  CheckEquals('Foo', FSession.FindAll<TFDCustomer>.First.Name);

  transaction.Commit;
  CheckEquals(1, FSession.FindAll<TFDCustomer>.Count);
  CheckEquals('Foo', FSession.FindAll<TFDCustomer>.First.Name);
end;

procedure TestFireDACSession.WhenSavingInTransaction_RollbackIsSuccessful;
var
  customer: TFDCustomer;
  transaction: IDBTransaction;
begin
  customer := CreateCustomer('Foo', 25);

  transaction := FSession.BeginTransaction;
  FSession.Save(customer);
  customer.Free;

  CheckEquals('Foo', FSession.FindAll<TFDCustomer>.First.Name);

  transaction.Rollback;
  CheckEquals(0, FSession.FindAll<TFDCustomer>.Count);
end;

initialization
  RegisterTest(TestFireDACSession.Suite);

end.
